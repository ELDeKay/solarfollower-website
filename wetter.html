<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />

  <!-- =========================================================
        Eigenschaften der Website
       - width=device-width: Layout passt sich der Gerätebreite an
       - initial-scale=1.0: Start-Zoom = 100%
       ========================================================= -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Wetterdaten</title>

  <style>
    /* =========================================================
       Globale Eingenschaften : Einheitliches Box-Modell für alle Elemente
       ========================================================= */
    *,
    *::before,
    *::after { box-sizing: border-box; }

    /* =========================================================
       Grundlayout der Seite
       ========================================================= */
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }

    /* =========================================================
       Kopfzeile
       - Desktop: Titel mittig, Zurück-Button rechts
       - Platz für Status (margin nur 10px)
       ========================================================= */
    .kopfzeile {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      width: 100%;
      max-width: 800px;
    }

    .kopfzeile h1 {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      text-align: center;
    }

    .zurueck-btn {
      text-decoration: none;
      background: #007BFF;
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: bold;
      margin-left: auto;
      touch-action: manipulation;
    }

    /* =========================================================
       Statuszeile (Zeitstempel)
       - zeigt, wann zuletzt Daten empfangen wurden
       ========================================================= */
    .zeitAbrufStatus {
      width: 100%;
      max-width: 800px;
      margin: 0 0 18px 0;
      font-size: 13px;
      color: #666;
      text-align: right;
    }

    /* =========================================================
       Auflistung Wettermesswerte
       - enthält Wetterwerte aus dem letzten Eintrag von /api/data
       ========================================================= */
    .liste {
      width: 100%;
      max-width: 800px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Eigenschaften einer Reihe in Auflistung */
    .reihe {
      display: grid;
      grid-template-columns: 120px 1fr auto;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #e0e0e0;
      gap: 12px;
      min-height: 72px;
    }

    .reihe:last-child { border-bottom: none; }

    /* Icon-Container (Bilder zur Visualisierung) */
    .icon {
      width: 100px;
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .messwerte {
      font-size: 18px;
      font-weight: bold;
    }

     /* Eigenschaften Texte der Einheiten und Messwerte */
    .einheit {
      display: flex;
      justify-content: flex-end;
      align-items: baseline;
      gap: 4px;
      font-size: 20px;
      font-weight: bold;
      white-space: nowrap;
    }

    .einheitText {
      font-size: 14px;
      font-weight: normal;
      color: #666;
    }

    /* =========================================================
       NEU: Eingabefelder + Button (unter Liste)
       ========================================================= */
    .eingabefeld { margin-top: 16px; }

    .eingabefeld label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }

    .eingabefeld input[type="number"],
    .eingabefeld input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .btns {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      background: #007BFF;
      color: white;
      cursor: pointer;
      touch-action: manipulation;
    }

    .btns:active { transform: scale(0.99); }

    /* =========================================================
       Mobile Anpassungen
       - kompaktere Zeilen, kleinere Icons, andere Grid-Spalten
       ========================================================= */
    @media (max-width: 600px) {
      body {
        padding: 14px;
        align-items: stretch;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
      }

      .kopfzeile {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        margin-bottom: 8px;
      }

      .kopfzeile h1 {
        position: static;
        transform: none;
        text-align: center;
      }

      .zurueck-btn {
        width: 100%;
        text-align: center;
        margin-left: 0;
      }

      .zeitAbrufStatus {
        text-align: center;
        margin-bottom: 14px;
      }

      .liste { padding: 16px; }

      .reihe {
        grid-template-columns: 56px 1fr auto;
        padding: 12px 0;
      }

      .icon { width: 44px; height: 44px; }
      .messwerte { font-size: 16px; }
      .einheit { font-size: 18px; }
    }
  </style>
</head>

<body>

  <!-- =========================================================
       Titel + Navigation zurück ins Hauptmenü
       ========================================================= -->
  <div class="kopfzeile">
    <h1>Wetterdaten</h1>
    <a class="zurueck-btn" href="index.html">Zurück zum Hauptmenü</a>
  </div>

  <!-- =========================================================
       Zeitstempel: zeigt den Zeitpunkt der zuletzt vom Pico empfangenen Daten
       ========================================================= -->
  <div class="zeitAbrufStatus" id="dataStamp">Keine Daten von Steuerung empfangen</div>

  <!-- =========================================================
       Werte-Liste: Wetterwerte aus /api/data (letzter Eintrag)
       ========================================================= -->
  <div class="liste">

    <div class="reihe">
      <div class="icon"><img src="windspeed.png" alt="Wind"></div>
      <div class="messwerte">Windstärke</div>
      <div class="einheit">
        <span id="wind">--</span><span class="einheitText">m/s</span>
      </div>
    </div>

    <div class="reihe">
      <div class="icon"><img src="sunrise.png" alt="Sonnenaufgang"></div>
      <div class="messwerte">Sonnenaufgang</div>
      <div class="einheit">
        <span id="sonneauf">--</span><span class="einheitText">Uhr</span>
      </div>
    </div>

    <div class="reihe">
      <div class="icon"><img src="sunset.png" alt="Sonnenuntergang"></div>
      <div class="messwerte">Sonnenuntergang</div>
      <div class="einheit">
        <span id="sonneunter">--</span><span class="einheitText">Uhr</span>
      </div>
    </div>

    <div class="reihe">
      <div class="icon"><img src="sunhours.png" alt="Sonnenstunden"></div>
      <div class="messwerte">Sonnenstunden</div>
      <div class="einheit">
        <span id="sonnenstunden">--</span><span class="einheitText">h</span>
      </div>
    </div>

    <!-- =========================================================
         NEU: Eingabefelder + Button (unter der Liste)
         ========================================================= -->
    <div class="eingabefeld">
      <label for="laufzeitSchuko">Laufzeit WLAN Steckdosen in Stunden</label>
      <input type="number" id="laufzeitSchuko" step="1" placeholder="z.B. 3" />
    </div>

    <div class="eingabefeld">
      <label for="ipSchuko">IP-Adresse WLAN Steckdose</label>
      <input
        type="text"
        id="ipSchuko"
        placeholder="z.B. 192.168.17.2"
        autocomplete="off"
        spellcheck="false"
      />
    </div>

    <div class="eingabefeld">
      <button id="sendeSchukoBtn" type="button" class="btns">
        Sende WLAN Steckdose Einstellungen
      </button>
    </div>

  </div>

<script>
/* =========================================================
   "Key"Namen und Variablen Deklarationen
   ========================================================= */
const API_BASE = "https://solar-backend-ljck.onrender.com";

/* =========================================================
   Überprüfung: IPv4-Adresse gültig?
   (aus der ersten Website übernommen)
   ========================================================= */
function istGueltigeIPv4(ip) {
  const parts = ip.split(".");
  if (parts.length !== 4) return false;
  return parts.every(p => {
    if (p.trim() === "") return false;
    if (!/^\d+$/.test(p)) return false;
    const n = Number(p);
    return n >= 0 && n <= 255;
  });
}

/* =========================================================
   Funktion: Einstellungen an Backend senden
   ========================================================= */
async function posteinstellungen(payload) {
  const res = await fetch(`${API_BASE}/api/einstellungen`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return res.json().catch(() => ({}));
}

/* =========================================================
   Helper: Zeit aus verschiedenen Formaten in "DD.MM.YYYY HH:MM:SS"
   - akzeptiert Unix-Timestamp (Sekunden), String-Zahl oder ISO-String
   - gibt null zurück, wenn nicht interpretierbar
   ========================================================= */
function formatISODateTime(value) {
  if (!value) return null;

  let d;

  // Fall 1: Unix Timestamp (Sekunden)
  if (typeof value === "number") {
    d = new Date(value * 1000);
  }
  // Fall 2: String-Zahl ("1768327581")
  else if (/^\d+$/.test(value)) {
    d = new Date(parseInt(value, 10) * 1000);
  }
  // Fall 3: ISO-String
  else {
    d = new Date(value);
  }

  if (isNaN(d.getTime())) return null;

  const datum = d.toLocaleDateString("de-DE", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric"
  });

  const zeit = d.toLocaleTimeString("de-DE", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });

  return `${datum} ${zeit}`;
}

/* =========================================================
   Funktion: Wetterdaten laden
   - holt /api/data vom Backend
   - nimmt den letzten Eintrag als aktuellsten Stand
   - aktualisiert Zeitstempel + Wetterfelder
   ========================================================= */
async function ladeWetterDaten() {
  try {
    const response = await fetch(`${API_BASE}/api/data`);
    const daten = await response.json();

    const stampEl = document.getElementById("dataStamp");

    if (!daten.length) {
      stampEl.innerText = "Keine Daten von Steuerung empfangen";
      return;
    }

    const letzterWert = daten[daten.length - 1];

    // Zeitstempel aktualisieren (wenn vorhanden)
    if (letzterWert.zeit) {
      const formatted = formatISODateTime(letzterWert.zeit);
      stampEl.innerText = formatted
        ? `Daten vom: ${formatted}`
        : "Keine gültige Zeitangabe empfangen";
    } else {
      stampEl.innerText = "Keine gültige Zeitangabe empfangen";
    }

    // Wetterwerte anzeigen (fallback: "--" wenn Feld fehlt oder null/undefined ist)
    document.getElementById("wind").innerText = letzterWert.wind ?? "--";
    document.getElementById("sonneauf").innerText = letzterWert.sonneauf ?? "--";
    document.getElementById("sonneunter").innerText = letzterWert.sonneunter ?? "--";
    document.getElementById("sonnenstunden").innerText = letzterWert.sonnenstunden ?? "--";

  } catch {
    document.getElementById("dataStamp").innerText = "Backend nicht erreichbar";
  }
}

/* =========================================================
   NEU: Button -> WLAN-Steckdose Einstellungen senden
   Variablen-Namen: ipSchuko, laufzeitSchuko
   ========================================================= */
const laufzeitSchukoInput = document.getElementById("laufzeitSchuko");
const ipSchukoInput = document.getElementById("ipSchuko");
const sendeSchukoBtn = document.getElementById("sendeSchukoBtn");

sendeSchukoBtn.addEventListener("click", async () => {
  const laufzeitSchukoRaw = (laufzeitSchukoInput.value || "").trim();
  const ipSchuko = (ipSchukoInput.value || "").trim();

  // Ganze Zahl (0 erlaubt)
  const laufzeitSchuko = Number(laufzeitSchukoRaw);
  if (laufzeitSchukoRaw === "" || !Number.isInteger(laufzeitSchuko)) {
    alert("Bitte eine gültige ganze Zahl eingeben (z. B. 3).");
    return;
  }

  // IPv4 prüfen
  if (!istGueltigeIPv4(ipSchuko)) {
    alert("Bitte geben Sie eine gültige IPv4-Adresse ein (z. B. 192.168.17.2).");
    return;
  }

  try {
    await posteinstellungen({ laufzeitSchuko, ipSchuko });
    alert("WLAN Steckdose Einstellungen wurden gesendet.");
  } catch {
    alert("Übertragung fehlgeschlagen.");
  }
});

/* =========================================================
   Initialisierung
   - Wetterdaten einmal sofort laden
   - danach regelmäßig aktualisieren
   ========================================================= */
ladeWetterDaten();
setInterval(ladeWetterDaten, 1000);
</script>

</body>
</html>
