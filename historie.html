<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analyse</title>
  <style>
    body 
      {
        font-family: Arial, sans-serif;
        background: #f0f0f0;
        margin: 0;
        padding: 20px;
      }

    .topbar 
      {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

    .topbar h1 
      {
        margin: 0;
      }

    .back-btn 
      {
        text-decoration: none;
        background: #007BFF;
        color: white;
        padding: 10px 16px;
        border-radius: 10px;
        font-weight: bold;
      }

    .list 
      {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-bottom: 20px;
      }

    .row 
      {
        display: grid;
        grid-template-columns: 120px 1fr 160px;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #e0e0e0;
      }

    .row:last-child 
      {
        border-bottom: none;
      }

    .icon 
      {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        color: #555;
      }
    
    .icon img 
      {
        width: 100%;          /* Bild f√ºllt Block gut aus */
        height: 100%;
        object-fit: contain;
      }

    .name 
      {
        font-size: 18px;
        font-weight: bold;
      }

    .value 
      {
        font-size: 20px;
        font-weight: bold;
        text-align: right;
      }

    #wattChartContainer 
      {
        max-width: 800px;
        margin: 0 auto 40px auto;
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

    #chartButtons 
      {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }

    #chartButtons button 
      {
        padding: 10px 16px;
        border-radius: 8px;
        border: none;
        background-color: #007BFF;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }

    #chartButtons button.active 
      {
        background-color: #0056b3;
      }
  </style>
</head>
<body>

  <div class="topbar">
    <h1>Analyse</h1>
    <a class="back-btn" href="index.html">Zur√ºck zum Hauptmen√º</a>
  </div>

  <div class="list">
    
    <div class="row">
      <div class="icon">
        <img src= "durchW.png">
      </div>
      <div class="name">Durchschnittl. Leistung</div>
      <div class="value" id="avgLive">XX,XX Watt</div>
    </div>

    <div class="row">
      <div class="icon">
       <img src= "durch24h.png"> 
      </div>
      <div class="name">Leistung 24h</div>
      <div class="value" id="avg24h">XX,XX Watt</div>
    </div>

    <div class="row">
      <div class="icon">
        <img src= "durch7d.png">
      </div>
      <div class="name">Leistung 7d</div>
      <div class="value" id="avg7d">XX,XX Watt</div>
    </div>

    <div class="row">
      <div class="icon">
        <img src="durch30d.png">
      </div>
      <div class="name">Leistung 30d</div>
      <div class="value" id="avg30d">XX,XX Watt</div>
    </div>

  </div>

  <div id="chartButtons">
    <button data-range="24h" class="active">24h</button>
    <button data-range="7d">7d</button>
    <button data-range="30d">30d</button>
    <button data-range="12m">12 Monate</button>
  </div>

  <div id="wattChartContainer">
    <canvas id="wattChart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const API_BASE = "https://solarfollower-databank.onrender.com";
    let currentChart;

    function berechneDurchschnitt(daten) 
      {
        if (!daten.length) return "0,00 Watt";
        const summe = daten.reduce((s, e) => s + e.watt, 0);
        return (summe / daten.length).toFixed(2).replace(".", ",") + " Watt";
      }

    async function ladeDurchschnittswerte() 
      {
        const map = 
          [
            { endpoint: "/api/watt_24h", element: "avg24h" },
            { endpoint: "/api/watt_7d",  element: "avg7d" },
            { endpoint: "/api/watt_30d", element: "avg30d" }
          ];

        for (const eintrag of map) 
          {
            const response = await fetch(`${API_BASE}${eintrag.endpoint}`);
            const daten = await response.json();
            document.getElementById(eintrag.element).textContent =
            berechneDurchschnitt(daten);
          }
      }

    function formatZeit(zeit, range) 
      {
        const d = new Date(zeit);
        if (range === "24h") return d.getHours() + ":00";
        if (range === "7d" || range === "30d")
        return d.toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit" });
        if (range === "12m")
        return d.toLocaleDateString("de-DE", { month: "short", year: "numeric" });
        return zeit;
      }

    async function ladeWattDaten(range) 
      {
        let endpoint;
        switch(range) 
          {
            case "24h": endpoint = "/api/watt_24h"; break;
            case "7d":  endpoint = "/api/watt_7d"; break;
            case "30d": endpoint = "/api/watt_30d"; break;
            case "12m": endpoint = "/api/watt_12monate"; break;
          }

        const response = await fetch(`${API_BASE}${endpoint}`);
        const daten = await response.json();

        const labels = daten.map(e => formatZeit(e.zeit, range));
        const wattData = daten.map(e => e.watt);


      // üîπ Aktueller Stundenwert = letzter Wert aus 24h
        if (range === "24h" && daten.length > 0) 
          {
            const letzterWert = daten[daten.length - 1].watt;
            document.getElementById("avgLive").textContent =
            letzterWert.toFixed(2).replace(".", ",") + " Watt";
          }


        const ctx = document.getElementById("wattChart").getContext("2d");
        if (currentChart) currentChart.destroy();

        currentChart = new Chart(ctx,
          {
            type: "line",
            data: 
              {
                labels,
                datasets: 
                  [
                    {
                      label: "Leistung (Watt)",
                      data: wattData,
                      borderColor: "#007BFF",
                      backgroundColor: "rgba(0,123,255,0.15)",
                      fill: true,
                      tension: 0.25,
                      pointRadius: 1,
                      pointHoverRadius: 3
                    }
                  ]
              },
            options: 
              {
                responsive: true,
                plugins: 
                  {
                    tooltip: 
                      {
                        enabled: true,
                        mode: 'nearest',
                        intersect: false,
                        callbacks: 
                          {
                            label: function(context) 
                              {
                                return context.parsed.y.toFixed(2) + " Watt";
                              }
                          }
                      }
                  },
                scales: 
                  {
                    x: { ticks: { autoSkip: true, maxTicksLimit: 10 } },
                    y: { title: { display: true, text: "Watt" } }
                  }
              }
          });
    }

    document.querySelectorAll("#chartButtons button").forEach(btn => 
      {
        btn.addEventListener("click", () => 
            {
              document.querySelectorAll("#chartButtons button")
              .forEach(b => b.classList.remove("active"));
              btn.classList.add("active");
              ladeWattDaten(btn.dataset.range);
            });
      });

    ladeWattDaten("24h");
    ladeDurchschnittswerte();
  </script>

</body>
</html>
