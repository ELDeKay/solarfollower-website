<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Steuerung</title>

  <style>
    body 
      {
        font-family: Arial, sans-serif;
        background: #f0f0f0;
        margin: 0;
        padding: 20px;
      }

    .topbar 
      {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

    .back-btn 
      {
        text-decoration: none;
        background: #007BFF;
        color: white;
        padding: 10px 16px;
        border-radius: 10px;
        font-weight: bold;
      }

    .motors 
      {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        max-width: 900px;
        margin: 0 auto;
      }

    .motor-box 
      {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        text-align: center;
      }

    .motor-box h2 
      {
        margin-bottom: 20px;
      }

    .value-box 
      {
        border: 2px solid #000;
        padding: 15px;
        margin-bottom: 15px;
        font-size: 18px;
        font-weight: bold;
      }

    .value-box span 
      {
        display: block;
        margin-top: 5px;
        font-size: 24px;
      }

    /* Eingabefelder & Buttons standardmäßig versteckt */
    .manual-motor-controls 
      {
        display: none;
      }


    .controls 
      {
        display: flex;
        justify-content: center;
        gap: 30px;
      }

    .btn 
      {
        width: 60px;
        height: 60px;
        font-size: 32px;
        font-weight: bold;
        border: none;
        border-radius: 12px;
        background: #007BFF;
        color: white;
        cursor: pointer;
      }

    .btn:active 
      {
        transform: scale(0.95);
      }

    .manuell-box 
      {
        max-width: 900px;
        margin: 40px auto 0;
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 20px;
      }

    input[type="checkbox"] 
      {
        width: 26px;
        height: 26px;
        cursor: pointer;
      }

    @media (max-width: 700px) 
      {
        .motors 
          {
            grid-template-columns: 1fr;
          }
      }
  </style>
</head>

<body>

  <div class="topbar">
    <h1>Steuerung</h1>
    <a class="back-btn" href="index.html">Zurück zum Hauptmenü</a>
  </div>

  <div class="motors">

    <!-- Motor 1 -->
    <div class="motor-box">
      <h2>Motor 1 – Drehen</h2>

      <div class="value-box">
        aktueller Wert
        <span id="motor1-current">-- °</span>
      </div>

      <div class="manual-motor-controls" id="motor1">
      <div class="value-box">
        Zielwert
      <span id="motor1-target" style="font-size:24px;font-weight:bold;">-- °</span>
      </div>


        <div class="controls">
          <button class="btn"
            onmousedown="startHold(1, -1)"
            onmouseup="stopHold()"
            onmouseleave="stopHold()"
            ontouchstart="startHold(1, -1)"
            ontouchend="stopHold()"
          >−</button>

          <button class="btn"
            onmousedown="startHold(1, +1)"
            onmouseup="stopHold()"
            onmouseleave="stopHold()"
            ontouchstart="startHold(1, +1)"
            ontouchend="stopHold()"
          >+</button>

        </div>
      </div>
    </div>

    <!-- Motor 2 -->
    <div class="motor-box">
      <h2>Motor 2 – Heben / Senken</h2>

      <div class="value-box">
        aktueller Wert
        <span id="motor2-current">-- °</span>
      </div>

      <div class="manual-motor-controls" id="motor2">
      <div class="value-box">
        Zielwert
      <span id="motor2-target" style="font-size:24px;font-weight:bold;">-- °</span>
      </div>


        <div class="controls">
          <button class="btn"
            onmousedown="startHold(2, -1)"
            onmouseup="stopHold()"
            onmouseleave="stopHold()"
            ontouchstart="startHold(2, -1)"
            ontouchend="stopHold()"
          >−</button>
          
          <button class="btn"
            onmousedown="startHold(2, +1)"
            onmouseup="stopHold()"
            onmouseleave="stopHold()"
            ontouchstart="startHold(2, +1)"
            ontouchend="stopHold()"
          >+</button>

        </div>
      </div>
    </div>

  </div>

  <div class="manuell-box">
    <span>manuelle Steuerung</span>
    <input type="checkbox" id="manuell">
  </div>

<script>
const API_BASE = "https://solar-backend-ljck.onrender.com";

const checkbox = document.getElementById("manuell");
const motor1_strg = document.getElementById("motor1");
const motor2_strg = document.getElementById("motor2");
const motor1Current = document.getElementById("motor1-current");
const motor2Current = document.getElementById("motor2-current");

const MOTOR_LIMITS = {
  1: { min: 0,  max: 300 },
  2: { min: 14, max: 75  }
};

/* ---------------- Backend-Daten laden ---------------- */

let uiInitialisiert = false;

async function ladeWetterdaten()
{
  try {
    const response = await fetch(`${API_BASE}/api/data`);
    const daten = await response.json();
    if (!daten.length) return;

    const letzterWert = daten[daten.length - 1];

    motor1Current.innerText =
      letzterWert.motor1 !== undefined ? `${letzterWert.motor1} °` : "-- °";

    motor2Current.innerText =
      letzterWert.motor2 !== undefined ? `${letzterWert.motor2} °` : "-- °";

    if (!uiInitialisiert) {
      checkbox.checked = !!letzterWert.manuell;
      motor1_strg.style.display = checkbox.checked ? "block" : "none";
      motor2_strg.style.display = checkbox.checked ? "block" : "none";
      uiInitialisiert = true;
    }
  }
  catch {
    console.log("Backend nicht erreichbar");
  }
}

/* ---------------- Manuell Checkbox ---------------- */

checkbox.addEventListener("change", async () =>
{
  const manuell = checkbox.checked;

  motor1_strg.style.display = manuell ? "block" : "none";
  motor2_strg.style.display = manuell ? "block" : "none";

  try {
    await fetch(`${API_BASE}/api/sturmmodus`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ aktiv: manuell })
    });
  }
  catch {
    console.log("Backend nicht erreichbar");
  }
});

/* ---------------- Motor Target senden ---------------- */

async function sendMotorTargets()
{
  const m1 = parseInt(document.getElementById("motor1-target").innerText);
  const m2 = parseInt(document.getElementById("motor2-target").innerText);

  if (isNaN(m1) || isNaN(m2)) return;

  try {
    await fetch(`${API_BASE}/api/motor_targets`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        motor1-target: m1,
        motor2-target: m2
      })
    });
  }
  catch {
    console.log("Motor-Zielwerte konnten nicht gesendet werden");
  }
}

/* ---------------- Button-Hold-Logik ---------------- */

let holdTimer = null;
let holdMotor = null;
let holdDirection = 0;
let holdStep = 1;

function changeMotorValue(motor, delta)
{
  const target = document.getElementById(`motor${motor}-target`);
  const current = document.getElementById(`motor${motor}-current`);

  let value = parseInt(target.innerText);
  if (isNaN(value)) value = parseInt(current.innerText) || 0;

  const { min, max } = MOTOR_LIMITS[motor];
  value = Math.max(min, Math.min(max, value + delta));

  target.innerText = value + " °";
}

function startHold(motor, direction)
{
  stopHold();

  holdMotor = motor;
  holdDirection = direction;
  holdStep = 1;

  changeMotorValue(holdMotor, holdDirection);

  holdTimer = setInterval(() =>
  {
    holdStep = Math.min(holdStep + 1, 8);
    changeMotorValue(holdMotor, holdDirection * holdStep);
  }, 150);
}

function stopHold()
{
  if (holdTimer) {
    clearInterval(holdTimer);
    holdTimer = null;

    // ✅ Zielwerte nach dem Einstellen ans Backend senden
    sendMotorTargets();
  }

  holdMotor = null;
  holdDirection = 0;
  holdStep = 1;
}

/* ---------------- Initial ---------------- */

ladeWetterdaten();
setInterval(ladeWetterdaten, 5000);
</script>



</body>
</html>
