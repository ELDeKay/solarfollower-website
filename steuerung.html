<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />

  <!-- =========================================================
        Eigenschaften der Website
       - width=device-width: Layout passt sich der Gerätebreite an
       - initial-scale=1.0: Start-Zoom = 100%
       ========================================================= -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Steuerung</title>

  <style>
    /* =========================================================
       Globale Eingenschaften : Einheitliches Box-Modell für alle Elemente
       ========================================================= */
    *,
    *::before,
    *::after { box-sizing: border-box; }

    html, body { height: 100%; }

    /* =========================================================
       Grundlayout der Seite
       ========================================================= */
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* =========================================================
       Kopfzeile
       - Desktop: Titel mittig, Zurück-Button rechts
       - Platz für Status (margin nur 10px)
       ========================================================= */
    .kopfzeile {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      width: 100%;
      max-width: 900px;
    }

    .kopfzeile h1 {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      text-align: center;
    }

    .zurueck-btn {
      text-decoration: none;
      background: #007BFF;
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: bold;
      margin-left: auto;
      display: inline-block;
      touch-action: manipulation;
    }

    /* =========================================================
       Statuszeile (Zeitstempel)
       - zeigt, wann zuletzt Daten von der Steuerung angekommen sind
       ========================================================= */
    .zeitAbrufStatus {
      width: 100%;
      max-width: 900px;
      margin: 0 0 18px 0;
      font-size: 13px;
      color: #666;
      text-align: right;
    }

    /* =========================================================
       Motoren-Grid
       - Desktop: zwei Spalten (Motor 1 / Motor 2)
       - Mobile: eine Spalte (via Media Query)
       ========================================================= */
    .motoren {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 900px;
      margin: 0;
    }

    /* Motoren-Box Eigneschaften*/
    .motor-box {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      text-align: center;
    }

    .motor-box h2 { margin: 0 0 20px 0; }

    /* Anzeige-Box für aktuellen Wert / Zielwert */
    .gradAnzeige-box {
      border: 2px solid #000;
      padding: 15px;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: bold;
    }

    .gradAnzeige-box span {
      display: block;
      margin-top: 5px;
      font-size: 24px;
    }

    /* Manuelle Motorsteuerung ist standardmäßig versteckt (erst bei "manuell" sichtbar) */
    .manuelleMotorSteuerung { display: none; }

    /* Plus/Minus Button-Zeile */
    .motorSteuerung {
      display: flex;
      justify-content: center;
      gap: 30px;
    }

    /* Button-Design für + / − */
    .btn {
      width: 60px;
      height: 60px;
      font-size: 32px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      background: #007BFF;
      color: white;
      cursor: pointer;

      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    .btn:active { transform: scale(0.95); }

    /* =========================================================
       Manuell-/Schneemodus Checkboxen
       - Schneemodus wird nur angezeigt, wenn manuell aktiv ist
       ========================================================= */
    .manuell-box {
      width: 100%;
      max-width: 900px;
      margin: 40px 0 0;
      margin-bottom: 12px;
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 20px;
      gap: 16px;
    }

    input[type="checkbox"] {
      width: 26px;
      height: 26px;
      cursor: pointer;
      flex: 0 0 auto;
    }

    /* =========================================================
       Mobile Anpassungen
       - 1 Spalte statt 2 für Motoren
       - Buttons / Abstände etwas kompakter
       ========================================================= */
    @media (max-width: 700px) {
      body {
        padding: 14px;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
        align-items: stretch;
      }

      .kopfzeile {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        margin-bottom: 8px;
      }

      .kopfzeile h1 {
        position: static;
        transform: none;
        text-align: center;
        order: 1;
      }

      .zurueck-btn {
        width: 100%;
        text-align: center;
        order: 2;
        margin-left: 0;
      }

      .zeitAbrufStatus {
        text-align: center;
        margin-bottom: 14px;
      }

      .motoren {
        grid-template-columns: 1fr;
        gap: 18px;
      }

      .motor-box { padding: 18px; }
      .motorSteuerung { gap: 18px; }

      .btn {
        width: 56px;
        height: 56px;
        font-size: 28px;
      }

      .manuell-box {
        padding: 18px;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>

  <!-- =========================================================
       Titel + Navigation zurück ins Hauptmenü
       ========================================================= -->
  <div class="kopfzeile">
    <h1>Steuerung</h1>
    <a class="zurueck-btn" id="backBtn" href="index.html">Zurück zum Hauptmenü</a>
  </div>

  <!-- =========================================================
       Statuszeile: zeigt Zeitstempel der zuletzt empfangenen Daten
       ========================================================= -->
  <div class="zeitAbrufStatus" id="dataStamp">Keine Daten von Steuerung empfangen</div>

  <!-- =========================================================
       Motor-Box:
       - oben: aktueller Wert (nur Anzeige)
       - unten: Zielwert + +/− Buttons (nur sichtbar in manuellem Modus)
       ========================================================= -->
  <div class="motoren">
    <div class="motor-box">
      <h2>Motor 1 – Drehen</h2>

      <div class="gradAnzeige-box">
        aktueller Wert
        <span id="motor1-drehen-aktueller-Wert">-- °</span>
      </div>

      <div class="manuelleMotorSteuerung" id="motor1">
        <div class="gradAnzeige-box">
          Zielwert
          <span id="motor1-Zielwert" style="font-size:24px;font-weight:bold;">-- °</span>
        </div>

        <div class="motorSteuerung">
          <button class="btn js-hold-btn" type="button" data-motor="1" data-dir="-1">−</button>
          <button class="btn js-hold-btn" type="button" data-motor="1" data-dir="1">+</button>
        </div>
      </div>
    </div>

    <div class="motor-box">
      <h2>Motor 2 – Heben / Senken</h2>

      <div class="gradAnzeige-box">
        aktueller Wert
        <span id="motor2-heb/senk-aktueller-Wert">-- °</span>
      </div>

      <div class="manuelleMotorSteuerung" id="motor2">
        <div class="gradAnzeige-box">
          Zielwert
          <span id="motor2-Zielwert" style="font-size:24px;font-weight:bold;">-- °</span>
        </div>

        <div class="motorSteuerung">
          <button class="btn js-hold-btn" type="button" data-motor="2" data-dir="-1">−</button>
          <button class="btn js-hold-btn" type="button" data-motor="2" data-dir="1">+</button>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       Schneemodus nur sichtbar, wenn manuelle Steuerung aktiv ist
       und kann nur dann Daten (bool) an das Backend schicken
       ========================================================= -->
  <div class="manuell-box" id="schneeModusBox" style="display:none;">
    <span>Schneemodus aktivieren</span>
    <input type="checkbox" id="schneeModus">
  </div>

  <!-- =========================================================
       Manuellmodus
       - blendet die Zielwert- und Steuer-UI ein/aus
       - aktiviert den Heartbeat, solange manuell aktiv ist
       ========================================================= -->
  <div class="manuell-box">
    <span>manuelle Steuerung</span>
    <input type="checkbox" id="manuell">
  </div>

<script>
  /* =========================================================
     "Key"Namen und Variablen Deklarationen
     ========================================================= */
const API_BASE = "https://solar-backend-ljck.onrender.com";

const manuellCb = document.getElementById("manuell");
const schneeModusCb = document.getElementById("schneeModus");
const schneeModusBox = document.getElementById("schneeModusBox");

const motor1DrehSteuer = document.getElementById("motor1");
const motor2Heb_SenkSteuer = document.getElementById("motor2");

const motor1DrehAktuellerWert = document.getElementById("motor1-drehen-aktueller-Wert");
const motor2Heb_SenkAktuellerWert = document.getElementById("motor2-heb/senk-aktueller-Wert");
const stampEl = document.getElementById("dataStamp");

/* =========================================================
   Grenzen für Zielwerte (damit keine unzulässigen Winkel gesendet werden)
   - Motor 1: 0..300 Grad
   - Motor 2: 14..75 Grad
   ========================================================= */
const motorGrenzbereich = {
  1: { min: 0,  max: 300 },
  2: { min: 14, max: 75 }
};

/* =========================================================
   UI helper: Manuell-UI ein-/ausblenden
   - zeigt Motor-Zielwert-Boxen und Schneemodus nur bei enabled=true
   ========================================================= */
function setManuellUI(enabled) {
  motor1DrehSteuer.style.display = enabled ? "block" : "none";
  motor2Heb_SenkSteuer.style.display = enabled ? "block" : "none";
  schneeModusBox.style.display = enabled ? "flex" : "none";
}

/* =========================================================
   Helper: Zeit aus verschiedenen Formaten in "DD.MM.YYYY HH:MM:SS"
   - akzeptiert Unix-Timestamp (Sekunden), String-Zahl oder ISO-String
   ========================================================= */
function formatISODateTime(value) {
  if (!value) return null;

  let d;
  if (typeof value === "number") d = new Date(value * 1000);
  else if (/^\d+$/.test(value)) d = new Date(parseInt(value, 10) * 1000);
  else d = new Date(value);

  if (isNaN(d.getTime())) return null;

  const datum = d.toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" });
  const zeit  = d.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  return `${datum} ${zeit}`;
}

/* =========================================================
   Funktion: /api/manuell Status ans Backend senden
   - payload enthält Checkbox-Zustände (manuell/schnee bool)
   - wirft Fehler, wenn HTTP nicht ok ist
   ========================================================= */
async function postManuell(payload) {
  const res = await fetch(`${API_BASE}/api/manuell`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error("HTTP " + res.status);
}

/* =========================================================
   Initialisierung: Modi beim Laden zurücksetzen
   - setzt Checkboxen auf false
   - versteckt Manuell-UI
   - sendet Reset an Backend
   ========================================================= */
(async function resetModiBeimLaden() {
  manuellCb.checked = false;
  schneeModusCb.checked = false;
  setManuellUI(false);

  try {
    await postManuell({ manuellModus: false, schneeModus: false });
  } catch {}
})();

/* =========================================================
   Auto-Reset bei Inaktivität (Frontend)
   - nach 2 Minuten ohne Nutzeraktionen wird manuell/schnee abgeschaltet
   - stoppt Heartbeat
   - sendet Reset ans Backend
   ========================================================= */
const IDLE_TIMEOUT_MS = 2 * 60 * 1000; // 2 Minuten
let idleTimer = null;

async function autoResetBecauseIdle() {
  if (!manuellCb.checked && !schneeModusCb.checked) return;

  manuellCb.checked = false;
  schneeModusCb.checked = false;
  setManuellUI(false);

  stopHeartbeat();

  try { await postManuell({ manuellModus: false, schneeModus: false }); } catch {}
}

function resetIdleTimer() {
  if (idleTimer) clearTimeout(idleTimer);
  idleTimer = setTimeout(autoResetBecauseIdle, IDLE_TIMEOUT_MS);
}

["pointerdown","pointermove","keydown","scroll","touchstart"].forEach((evt) => {
  window.addEventListener(evt, resetIdleTimer, { passive: true });
});
resetIdleTimer();

/* =========================================================
   Heartbeat: nur wenn manuell aktiv
   - sendet alle 20s ein Lebenszeichen ans Backend
   - Backend kann damit erkennen, ob die Steuerungsseite noch offen ist
   ========================================================= */
let heartbeatTimer = null;

async function sendHeartbeat() {
  if (!manuellCb.checked) return;

  try {
    await fetch(`${API_BASE}/api/heartbeat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ page: "steuerung" })
    });
  } catch {}
}

function startHeartbeat() {
  stopHeartbeat();
  sendHeartbeat();
  heartbeatTimer = setInterval(sendHeartbeat, 20000);
}

function stopHeartbeat() {
  if (heartbeatTimer) clearInterval(heartbeatTimer);
  heartbeatTimer = null;
}

/* =========================================================
   Function: Motor-Daten laden (nur Anzeige der aktuellen Werte)
   - holt /api/data
   - nimmt den letzten Eintrag als aktuellsten Stand
   - aktualisiert Zeitstempel + aktuelle Motorwinkel
   ========================================================= */
async function ladeMotorDaten() {
  try {
    const response = await fetch(`${API_BASE}/api/data`);
    const daten = await response.json();

    if (!daten.length) {
      stampEl.innerText = "Keine Daten von Steuerung empfangen";
      return;
    }

    const letzterWert = daten[daten.length - 1];

    if (letzterWert.zeit) {
      const formatted = formatISODateTime(letzterWert.zeit);
      stampEl.innerText = formatted ? `Daten vom: ${formatted}` : "Keine gültige Zeitangabe empfangen";
    } else {
      stampEl.innerText = "Keine gültige Zeitangabe empfangen";
    }

    motor1DrehAktuellerWert.innerText = letzterWert.motor1 !== undefined ? `${letzterWert.motor1} °` : "-- °";
    motor2Heb_SenkAktuellerWert.innerText = letzterWert.motor2 !== undefined ? `${letzterWert.motor2} °` : "-- °";
  } catch {
    stampEl.innerText = "Backend nicht erreichbar";
  }
}

/* =========================================================
   Checkbox: manuelle Steuerung
   - blendet Zielwert-Steuerung ein/aus
   - startet/stopt Heartbeat
   - schaltet bei "aus" den Schneemodus automatisch ab
   ========================================================= */
manuellCb.addEventListener("change", async () => {
  const manuell = manuellCb.checked;
  setManuellUI(manuell);

  if (manuell) {
    startHeartbeat();
  } else {
    schneeModusCb.checked = false;
    stopHeartbeat();
    try { await postManuell({ schneeModus: false }); } catch {}
  }

  try {
    await postManuell({ manuellModus: manuell });
  } catch {
    // rollback, wenn Backend-Request fehlschlägt
    manuellCb.checked = !manuell;
    setManuellUI(manuellCb.checked);
    if (manuellCb.checked) startHeartbeat(); else stopHeartbeat();
  }
});

/* =========================================================
   Checkbox: Schneemodus
   - kann nur aktiviert werden, wenn manuell aktiv ist
   - sendet Zustand ans Backend
   ========================================================= */
schneeModusCb.addEventListener("change", async () => {
  if (!manuellCb.checked) {
    schneeModusCb.checked = false;
    return;
  }

  const schneeModus = schneeModusCb.checked;
  try {
    await postManuell({ schneeModus });
  } catch {
    schneeModusCb.checked = !schneeModus;
  }
});

/* =========================================================
   Funktion: Motor-Zielwerte ans Backend senden
   - liest Zielwerte aus dem UI (motor1-Zielwert/motor2-Zielwert)
   - sendet POST /api/motor_Zielwert mit nur den gesetzten Werten
   ========================================================= */
async function motorZielwertSenden() {
  const m1 = parseInt(document.getElementById("motor1-Zielwert").innerText, 10);
  const m2 = parseInt(document.getElementById("motor2-Zielwert").innerText, 10);

  if (isNaN(m1) && isNaN(m2)) return;

  const payload = {};
  if (!isNaN(m1)) payload.motor1_Zielwert = m1;
  if (!isNaN(m2)) payload.motor2_Zielwert = m2;

  try {
    const res = await fetch(`${API_BASE}/api/motor_Zielwert`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
  } catch {
    console.log("Motor-Zielwerte konnten nicht gesendet werden");
  }
}

/* =========================================================
   Button-Hold-Logik (+ / − gedrückt halten)
   - pointerdown: startet wiederholtes Ändern des Zielwerts
   - pointerup/cancel/leave: stoppt und sendet Zielwert ans Backend
   - holdStep erhöht sich, damit längeres Halten schneller wird
   ========================================================= */
let holdTimer = null;
let holdMotor = null;
let holdDirection = 0;
let holdStep = 1;

function motorenWerteAendern(motor, delta) {
  const target = document.getElementById(`motor${motor}-Zielwert`);
  const current = motor === 1
    ? document.getElementById("motor1-drehen-aktueller-Wert")
    : document.getElementById("motor2-heb/senk-aktueller-Wert");

  if (!target || !current) return;

  let value = parseInt(target.innerText, 10);
  if (isNaN(value)) value = parseInt(current.innerText, 10) || 0;

  const { min, max } = motorGrenzbereich[motor];
  value = Math.max(min, Math.min(max, value + delta));
  target.innerText = value + " °";
}

function startHold(motor, direction) {
  stopHold();
  holdMotor = motor;
  holdDirection = direction;
  holdStep = 1;

  motorenWerteAendern(holdMotor, holdDirection);

  holdTimer = setInterval(() => {
    holdStep = Math.min(holdStep + 1, 8);
    motorenWerteAendern(holdMotor, holdDirection * holdStep);
  }, 150);
}

function stopHold() {
  if (holdTimer) {
    clearInterval(holdTimer);
    holdTimer = null;
    motorZielwertSenden();
  }
  holdMotor = null;
  holdDirection = 0;
  holdStep = 1;
}

function bindHoldButtons() {
  const buttons = document.querySelectorAll(".js-hold-btn");
  buttons.forEach((btn) => {
    btn.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      try { btn.setPointerCapture(e.pointerId); } catch {}
      const motor = parseInt(btn.dataset.motor, 10);
      const dir = parseInt(btn.dataset.dir, 10);
      startHold(motor, dir);
    });

    btn.addEventListener("pointerup", (e) => { e.preventDefault(); stopHold(); });
    btn.addEventListener("pointercancel", stopHold);
    btn.addEventListener("pointerleave", stopHold);
    btn.addEventListener("contextmenu", (e) => e.preventDefault());
  });
}

/* =========================================================
   Initialisierung
   - Hold-Buttons aktivieren
   - aktuelle Daten sofort laden
   - danach alle 5 Sekunden aktualisieren
   ========================================================= */
bindHoldButtons();
ladeMotorDaten();
setInterval(ladeMotorDaten, 5000);
</script>

</body>
</html>
