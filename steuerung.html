<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Steuerung</title>

  <style>
    *,
    *::before,
    *::after { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* ✅ Topbar: Desktop Titel exakt mittig, Button rechts */
    .topbar {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 10px; /* kleiner, weil Statuszeile darunter */
      width: 100%;
      max-width: 900px;
    }

    .topbar h1 {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      text-align: center;
    }

    .back-btn {
      text-decoration: none;
      background: #007BFF;
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: bold;
      margin-left: auto;
      display: inline-block;
      touch-action: manipulation;
    }

    /* ✅ Statuszeile wie bei wetter.html */
    .stamp {
      width: 100%;
      max-width: 900px;
      margin: 0 0 18px 0;
      font-size: 13px;
      color: #666;
      text-align: right;
    }

    /* ✅ Motor-Grid */
    .motors {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 900px;
      margin: 0;
    }

    .motor-box {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      text-align: center;
    }

    .motor-box h2 {
      margin: 0 0 20px 0;
    }

    .value-box {
      border: 2px solid #000;
      padding: 15px;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: bold;
    }

    .value-box span {
      display: block;
      margin-top: 5px;
      font-size: 24px;
    }

    .manual-motor-controls { display: none; }

    .controls {
      display: flex;
      justify-content: center;
      gap: 30px;
    }

    .btn {
      width: 60px;
      height: 60px;
      font-size: 32px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      background: #007BFF;
      color: white;
      cursor: pointer;

      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    .btn:active { transform: scale(0.95); }

    .manuell-box {
      width: 100%;
      max-width: 900px;
      margin: 40px 0 0;
      margin-bottom: 12px;
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 20px;
      gap: 16px;
    }

    input[type="checkbox"] {
      width: 26px;
      height: 26px;
      cursor: pointer;
      flex: 0 0 auto;
    }

    @media (max-width: 700px) {
      body {
        padding: 14px;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
        align-items: stretch;
      }

      .topbar {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        margin-bottom: 8px;
      }

      .topbar h1 {
        position: static;
        transform: none;
        text-align: center;
        order: 1;
      }

      .back-btn {
        width: 100%;
        text-align: center;
        order: 2;
        margin-left: 0;
      }

      .stamp {
        text-align: center;
        margin-bottom: 14px;
      }

      .motors {
        grid-template-columns: 1fr;
        gap: 18px;
      }

      .motor-box { padding: 18px; }

      .controls { gap: 18px; }

      .btn {
        width: 56px;
        height: 56px;
        font-size: 28px;
      }

      .manuell-box {
        padding: 18px;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>

  <div class="topbar">
    <h1>Steuerung</h1>
    <a class="back-btn" href="index.html">Zurück zum Hauptmenü</a>
  </div>

  <!-- ✅ Zeit / Status -->
  <div class="stamp" id="dataStamp">Keine Daten von Steuerung empfangen</div>

  <div class="motors">

    <!-- Motor 1 -->
    <div class="motor-box">
      <h2>Motor 1 – Drehen</h2>

      <div class="value-box">
        aktueller Wert
        <span id="motor1-current">-- °</span>
      </div>

      <div class="manual-motor-controls" id="motor1">
        <div class="value-box">
          Zielwert
          <span id="motor1-target" style="font-size:24px;font-weight:bold;">-- °</span>
        </div>

        <div class="controls">
          <button class="btn js-hold-btn" type="button" data-motor="1" data-dir="-1">−</button>
          <button class="btn js-hold-btn" type="button" data-motor="1" data-dir="1">+</button>
        </div>
      </div>
    </div>

    <!-- Motor 2 -->
    <div class="motor-box">
      <h2>Motor 2 – Heben / Senken</h2>

      <div class="value-box">
        aktueller Wert
        <span id="motor2-current">-- °</span>
      </div>

      <div class="manual-motor-controls" id="motor2">
        <div class="value-box">
          Zielwert
          <span id="motor2-target" style="font-size:24px;font-weight:bold;">-- °</span>
        </div>

        <div class="controls">
          <button class="btn js-hold-btn" type="button" data-motor="2" data-dir="-1">−</button>
          <button class="btn js-hold-btn" type="button" data-motor="2" data-dir="1">+</button>
        </div>
      </div>
    </div>

  </div>

<div class="manuell-box">
  <span>manuelle Steuerung</span>
  <input type="checkbox" id="manuell">
</div>

<div class="manuell-box">
  <span>Schneemodus aktivieren</span>
  <input type="checkbox" id="snowmode">
</div>
  
<script>
const API_BASE = "https://solar-backend-ljck.onrender.com";

const checkbox = document.getElementById("manuell");
const snowCheckbox = document.getElementById("snowmode");
const motor1_strg = document.getElementById("motor1");
const motor2_strg = document.getElementById("motor2");
const motor1Current = document.getElementById("motor1-current");
const motor2Current = document.getElementById("motor2-current");
const stampEl = document.getElementById("dataStamp");

const MOTOR_LIMITS = {
  1: { min: 0,  max: 300 },
  2: { min: 14, max: 75  }
};

let uiInitialisiert = false;

function formatISODateTime(value) {
  if (!value) return null;

  let d;

  // Fall 1: Unix Timestamp (Sekunden)
  if (typeof value === "number") {
    d = new Date(value * 1000);
  }
  // Fall 2: String-Zahl ("1768327581")
  else if (/^\d+$/.test(value)) {
    d = new Date(parseInt(value, 10) * 1000);
  }
  // Fall 3: ISO-String
  else {
    d = new Date(value);
  }

  if (isNaN(d.getTime())) return null;

  const datum = d.toLocaleDateString("de-DE", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric"
  });

  const zeit = d.toLocaleTimeString("de-DE", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });

  return `${datum} ${zeit}`;
}


/* ---------------- Backend-Daten laden ---------------- */
async function ladeWetterdaten() {
  try {
    const response = await fetch(`${API_BASE}/api/data`);
    const daten = await response.json();

    if (!daten.length) {
      stampEl.innerText = "Keine Daten von Steuerung empfangen";
      return;
    }

    const letzterWert = daten[daten.length - 1];

    // ✅ Zeitstempel
    if (letzterWert.zeit) {
      const formatted = formatISODateTime(letzterWert.zeit);
      stampEl.innerText = formatted
        ? `Daten vom: ${formatted}`
        : "Keine gültige Zeitangabe empfangen";
    } else {
      stampEl.innerText = "Keine gültige Zeitangabe empfangen";
    }

    motor1Current.innerText =
      letzterWert.motor1 !== undefined ? `${letzterWert.motor1} °` : "-- °";

    motor2Current.innerText =
      letzterWert.motor2 !== undefined ? `${letzterWert.motor2} °` : "-- °";

    if (!uiInitialisiert) {
      checkbox.checked = !!letzterWert.manuell;
      motor1_strg.style.display = checkbox.checked ? "block" : "none";
      motor2_strg.style.display = checkbox.checked ? "block" : "none";
      uiInitialisiert = true;
    }
  }
  catch {
    stampEl.innerText = "Backend nicht erreichbar";
    console.log("Backend nicht erreichbar");
  }
}

/* ---------------- Manuell Checkbox ---------------- */
checkbox.addEventListener("change", async () => {
  const manuell = checkbox.checked;

  motor1_strg.style.display = manuell ? "block" : "none";
  motor2_strg.style.display = manuell ? "block" : "none";

  try {
    await fetch(`${API_BASE}/api/manuell`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ aktiv: manuell })
    });
  }
  catch {
    console.log("Backend nicht erreichbar");
  }
});

  /* ---------------- Schneemodus Checkbox ---------------- */
snowCheckbox.addEventListener("change", async () => {
  const snowmode = snowCheckbox.checked;

  try {
    await fetch(`${API_BASE}/api/snowmode`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ snowmode })
    });
  }
  catch {
    console.log("Backend nicht erreichbar (snowmode)");
  }
});

/* ---------------- Motor Target senden ---------------- */
async function sendMotorTargets() {
  const m1 = parseInt(document.getElementById("motor1-target").innerText);
  const m2 = parseInt(document.getElementById("motor2-target").innerText);

  if (isNaN(m1) || isNaN(m2)) return;

  try {
    await fetch(`${API_BASE}/api/motor_targets`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ motor1_target: m1, motor2_target: m2 })
    });
  }
  catch {
    console.log("Motor-Zielwerte konnten nicht gesendet werden");
  }
}

/* ---------------- Button-Hold-Logik ---------------- */
let holdTimer = null;
let holdMotor = null;
let holdDirection = 0;
let holdStep = 1;

function changeMotorValue(motor, delta) {
  const target = document.getElementById(`motor${motor}-target`);
  const current = document.getElementById(`motor${motor}-current`);

  let value = parseInt(target.innerText);
  if (isNaN(value)) value = parseInt(current.innerText) || 0;

  const { min, max } = MOTOR_LIMITS[motor];
  value = Math.max(min, Math.min(max, value + delta));

  target.innerText = value + " °";
}

function startHold(motor, direction) {
  stopHold();

  holdMotor = motor;
  holdDirection = direction;
  holdStep = 1;

  changeMotorValue(holdMotor, holdDirection);

  holdTimer = setInterval(() => {
    holdStep = Math.min(holdStep + 1, 8);
    changeMotorValue(holdMotor, holdDirection * holdStep);
  }, 150);
}

function stopHold() {
  if (holdTimer) {
    clearInterval(holdTimer);
    holdTimer = null;
    sendMotorTargets();
  }

  holdMotor = null;
  holdDirection = 0;
  holdStep = 1;
}

/* ---------------- ✅ Pointer Events Binding ---------------- */
function bindHoldButtons() {
  const buttons = document.querySelectorAll(".js-hold-btn");

  buttons.forEach((btn) => {
    btn.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      try { btn.setPointerCapture(e.pointerId); } catch {}
      const motor = parseInt(btn.dataset.motor, 10);
      const dir = parseInt(btn.dataset.dir, 10);
      startHold(motor, dir);
    });

    btn.addEventListener("pointerup", (e) => {
      e.preventDefault();
      stopHold();
    });

    btn.addEventListener("pointercancel", stopHold);
    btn.addEventListener("pointerleave", stopHold);
    btn.addEventListener("contextmenu", (e) => e.preventDefault());
  });
}

/* ---------------- Initial ---------------- */
bindHoldButtons();
ladeWetterdaten();
setInterval(ladeWetterdaten, 5000);
</script>

</body>
</html>
